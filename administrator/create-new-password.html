<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>CSWD Forgot Password</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="shortcut icon" href="assets/img/icons/santarosa-logo.ico" type="image/x-icon">
</head>

<body>
    <section class="position-relative py-4 py-xl-5">
        <div class="container">
            <div class="row mb-5">
                <div class="col-md-8 col-xl-6 mx-auto">
                    <h1>Reset your Password</h1>
                    <?php
                        if(isset($_GET["selector"]) && isset($_GET["validator"])){                        
                            $selector = $_GET["selector"];
                            $validator = $_GET["validator"];
                            $email = $_GET["email"];
                            if(ctype_xdigit($selector)!== false && ctype_xdigit($validator)!== false){
                                ?>
                                <form action="includes/reset-password.inc.php" method="post" novalidate>
                                    <input type="hidden" name="selector" value="<?php echo $selector ?>">
                                    <input type="hidden" name="validator" value="<?php echo $validator ?>">
                                    <input type="hidden" id="email" name="email" value="<?php echo $email ?>">
                                    <div class="row mb-3">
                                        <input class="form-control password" id="new_password" type="password" name="pwd" placeholder="Enter a new password..." required>
                                        <span id="newpassworderror" class='text-danger'></span>
                                    </div>
                                    <div class="row mb-3">
                                        <input class="form-control password" id="confirm_new_password" type="password" name="pwd-repeat" placeholder="Repeat your new password..." required>
                                        <span id="confirmpassworderror" class='text-danger'></span>
                                    </div>
                                    <label id="showPasswordLabel" for="showPassword">Show Password</label>
                                    <input class="toggle-password" type="checkbox" id="showPassword">
                                    <div id="error-message" class='text-danger'>
                                        <?php
                                            if (isset($_GET['error'])) {
                                                if ($_GET['error'] == "empty") {
                                                    echo "<p class='text-danger'>Empty password!</p>";
                                                } else if ($_GET['error'] == "passwordcheck") {
                                                    echo "<p class='text-danger'>Passwords do not match!</p>";
                                                } else if ($_GET['error'] == "useoldpassword") {
                                                    echo "<p class='text-danger'>Cannot use old password!</p>";
                                                } else if ($_GET['error'] == "invalidpassword") {
                                                    echo "<p class='text-danger'>Invalid Password!</p>";
                                                }
                                            } else if (isset($_GET['success'])) {
                                                echo "<p class='text-success'>Password changed successfully!</p>";
                                            }
                                        ?>
                                    </div>
                                    <button class="btn btn-primary" type="submit" name="reset-password-submit">Reset password</button>
                                </form>
                                <?php
                            }
                        } else {
                                echo "Could not validate your request!";
                            }
                    ?>
                </div>
            </div>
        </div>
    </section>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/jquery-3.6.0.min.js"></script>
    <script>
        var email = $("#email").val();
        var newPassword = $("#new_password");
        var confirmNewPassword = $("#confirm_new_password");
        // Add event listener to old password
        newPassword.on("change", function() {
            $.ajax({
                url: "includes/get_user_password.php",
                method: "POST",
                dataType: "json",
                data: {
                    username: email,
                    oldPassword: newPassword.val(),
                },
                success: function(response) {
                    // Handle the response from the server
                    if (response === "Correct Old Password") {
                        $("#newpassworderror").html("Cannot use old password.");
                        $("#new_password").removeClass("is-valid");
                        $("#new_password").addClass("is-invalid");
                    } else {
                        $("#newpassworderror").html("");
                        $("#new_password").removeClass("is-invalid");
                        $("#new_password").addClass("is-valid");
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    // Show an error message to the user
                    Swal.fire({
                        title: "Error",
                        text: "Failed to make the request to the server.",
                        icon: "error"
                    });
                }
            });
        });

        confirmNewPassword.on("input", function() {
            // Compare the values of newPassword and confirmNewPassword
            if (newPassword.val() !== confirmNewPassword.val()) {
                // Display an error message
                $("#confirmpassworderror").html("New password and confirmed password do not match.");
            } else {
                // Clear the error message
                $("#confirmpassworderror").html("");
            }
        });
        $(".toggle-password").click(function() {
            const passwordField = $('.password');

            if (passwordField.attr("type") === "password") {
                passwordField.attr("type", "text");
                $("#showPasswordLabel").text("Hide Password");
            } else {
                passwordField.attr("type", "password");
                $("#showPasswordLabel").text("Show Password");
            }
        });
        var passwordField = $('.password[type=password]:not(#old_password)');

        // Attach a keyup event listener to the password field
        passwordField.on('keyup', function() {
            // Get the password value
            var password = $(this).val();

            // Set the regular expressions for each password requirement
            var regexCapitalLetter = /[A-Z]/;
            var regexSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/;
            var regexNumber = /\d/;
            var regexSpace = /\s/;

            // Check if the password meets all requirements
            if (password.length < 8) {
                $('#error-message').text('Password must be at least 8 characters long');
            } else if (regexSpace.test(password)) {
                $('#error-message').text('Password must not contain spaces');
            } else if (!regexCapitalLetter.test(password)) {
                $('#error-message').text('Password must contain at least one capital letter');
            } else if (!regexSymbol.test(password)) {
                $('#error-message').text('Password must contain at least one symbol');
            } else if (!regexNumber.test(password)) {
                $('#error-message').text('Password must contain at least one number');
            } else {
                $('#error-message').text('');
            }
        });
    </script>
</body>

</html>